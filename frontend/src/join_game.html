<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>New Song Rating Game</title>

    <link rel="stylesheet" href="styles.css" />
    <script src="script.js"></script>

    <style>
      .content {
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
        margin: 0;
        padding: 0;
        flex: 1;
        box-sizing: border-box;
        text-align: center;
      }

      #header {
        margin-bottom: 20px;
      }

      .dynamic-content {
        visibility: hidden; /* start invisible */
      }

      #game-info {
        margin: 10px;
        padding: 0 25px;
        border-radius: 25px;
        border: 5px solid var(--accent-color-3);
        background-color: white;
        color: var(--color-black);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        width: 70%;
        max-width: 600px;
      }
      #game-info * {
        text-shadow: none;
      }
      #game-info pre {
        white-space: pre-wrap;
        text-align: left;
        font-family: var(--site-font);
      }
      #game-info hr {
        border: 1px solid var(--accent-color-2);
      }

      .content h1,
      h2,
      p {
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
      }

      .content input {
        border-radius: 8px;
        padding: 15px;
        outline: none;
        border: none;
        background-color: var(--color-white);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        text-align: center;
      }

      @media (min-width: 500px) {
        #player-info {
          display: flex;
        }
      }
      .player-info-element {
        margin: 0 15px;
        display: flex;
        flex-direction: column;
      }

      .content label {
        margin-top: 30px;
        margin-bottom: 10px;
        font-size: 20px;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
      }
      .required-label::after {
        content: " *";
        color: var(--color-error);
        font-weight: bold;
      }

      #error-message {
        color: var(--color-error);
        margin: 10px 20px;
        min-height: 40px;
      }

      #join-button {
        border-radius: 8px;
        margin-bottom: 75px;
        padding: 15px;
        font-size: 18px;
        outline: none;
        border: none;
        text-align: center;
        font-weight: bold;
        background-color: var(--accent-color-3);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      #join-button:hover {
        background-color: var(--accent-color-2);
      }
    </style>
  </head>
  <body>
    <script>
      components.top_nav_bar();
    </script>

    <div class="content">
      <p id="loading-msg">loading...</p>

      <h1 id="header" class="dynamic-content">Join Game</h1>

      <div id="game-info" class="dynamic-content"></div>

      <div id="player-info" class="dynamic-content">
        <div class="player-info-element">
          <label for="player-name" class="required-label">Name</label>
          <input
            id="player-name"
            type="text"
            placeholder="e.g. Keegan"
            maxlength="255"
            required
          />
        </div>

        <div class="player-info-element">
          <label for="playlist-link">Playlist Link</label>
          <input
            id="playlist-link"
            type="text"
            placeholder="e.g. open.spotify.com/..."
            maxlength="255"
          />
        </div>
      </div>

      <div id="song-inputs" class="dynamic-content"></div>

      <p id="error-message" class="dynamic-content"></p>

      <button id="join-button" class="dynamic-content">Join</button>
    </div>

    <script>
      function makeDynamicElementsVisible() {
        document.getElementById("loading-msg").remove();
        document.querySelectorAll(".dynamic-content").forEach((element) => {
          element.style.visibility = "visible";
        });
      }

      function displayErrorScreen(msg) {
        document.getElementById("loading-msg").remove();

        const headerElement = document.getElementById("header");
        const errorMessageElement = document.getElementById("error-message");

        document.querySelectorAll(".dynamic-content").forEach((element) => {
          if (element !== headerElement && element !== errorMessageElement) {
            element.remove();
          }
        });

        headerElement.style.visibility = "visible";

        errorMessageElement.innerText = msg;
        errorMessageElement.style.visibility = "visible";
      }

      // generate the dynamic content from the invite_code parameter in the url
      (() => {
        const inviteCode = new URLSearchParams(window.location.search).get(
          "invite_code"
        );

        // validate invite code
        if (!inviteCode) {
          displayErrorScreen("No invite code provided.");
          return;
        }
        if (!/^I[a-zA-Z0-9]{15}$/.test(inviteCode)) {
          displayErrorScreen("The invite code has an invalid format.");
          return;
        }

        // request server data with validated invite code
        sendRequest("GET", `/api/game/peek/${inviteCode}`, undefined, [404])
          .then(([status, resJson]) => {
            const gameInfoDiv = document.getElementById("game-info");

            if (status === 404) {
              displayErrorScreen("The invite code is invalid or expired.");
              return;
            }

            const gameName = resJson.gameName;
            const minSongs = resJson.min_songs_per_playlist;
            const maxSongs = resJson.max_songs_per_playlist;
            const gameDescription = resJson.game_description;
            const playlistLinkIsRequired = resJson.require_playlist_link;

            // game name
            const gameNameElement = document.createElement("h2");
            gameNameElement.innerText = resJson.game_name;

            // songs per playlist
            const songsPerPlaylistElement = document.createElement("h4");
            songsPerPlaylistElement.innerText =
              (minSongs === maxSongs ? minSongs : `${minSongs}-${maxSongs}`) +
              " songs per playlist";

            const gameInfoElements = [gameNameElement, songsPerPlaylistElement];

            // game description and a horizontal rule (if provided)
            if (gameDescription) {
              const gameDescriptionElement = document.createElement("pre");
              gameDescriptionElement.innerText = gameDescription;
              gameInfoElements.push(
                document.createElement("hr"),
                gameDescriptionElement
              );
            }

            gameInfoDiv.replaceChildren(...gameInfoElements);

            // display whether the playlist link field is required
            if (playlistLinkIsRequired) {
              document.getElementById("playlist-link").required = true;
              document
                .querySelector('label[for="playlist-link"]')
                ?.classList.add("required-label");
            }

            makeDynamicElementsVisible();
          })
          .catch((err) => {
            displayErrorScreen(err.message);
          });
      })();
    </script>
  </body>
</html>
